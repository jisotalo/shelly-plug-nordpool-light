/**
 * @license
 * 
 * shelly-plug-nordpool-light
 * 
 * (c) Jussi isotalo - http://jisotalo.fi
 * https://github.com/jisotalo/shelly-plug-nordpool-light
 * 
 * License: GNU Affero General Public License v3.0 
 */
let l="shelly-plug-nordpool-light",C_ERRC=3,C_ERRD=120,C_DEF={g:"fi",v:24,ns:22,ne:7,nb:-10,nf:0,ob:10,c:[[null,255,255,255,0,0],[null,255,0,0,50,1],[0,0,255,0,10,0],[5,0,255,0,10,0],[10,255,120,0,10,0],[15,255,64,0,10,0],[20,255,0,0,10,0],[null,255,255,255,100,0]]},_={s:{v:"1.0.0",dn:"",st:0,chkTs:0,errCnt:0,errTs:0,configOK:0,p:null,c:1,f:0,fa:0},c:C_DEF},o=!1,t=!1,i=null,e=!1;function c(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function f(e){console.log((new Date).toString().substring(16,24)+":",e)}function u(){var e=new Date;_.s.timeOK=2e3<e.getFullYear()?1:0,_.s.dn=Shelly.getComponentConfig("sys").device.name,!_.s.upTs&&_.s.timeOK&&(_.s.upTs=c(e))}function a(e){Shelly.call("KVS.Get",{key:l},function(t,e,s,n){_.c=t?t.value:{},"function"==typeof USER_CONFIG&&(_.c=USER_CONFIG(_.c,_,!0));{t=function(e){_.s.configOK=e?1:0,_.s.chkTs=0,n&&(o=!1,Timer.set(1e3,!1,h))};let e=0;if(C_DEF){for(var r in C_DEF)void 0===_.c[r]&&(_.c[r]=C_DEF[r],e++);C_DEF=null,0<e?Shelly.call("KVS.Set",{key:l,value:_.c},function(e,t,s,n){0!==t&&f("chkConfig() - error:"+t+" - "+s),n&&n(0===t)},t):t&&t(!0)}else t&&t(!0)}},e)}function h(){try{if(!o)if(o=!0,u(),_.s.configOK)if(e)if(function(){var e=new Date;{if(_.s.errCnt>=C_ERRC&&c(e)-_.s.errTs<C_ERRD)return C_ERRD,c(e),void _.s.errTs;_.s.errCnt>=C_ERRC&&(_.s.errCnt=0)}if(0==_.s.chkTs)return 1;var t=new Date(1e3*_.s.chkTs);return t.getHours()!=e.getHours()&&0<e.getMinutes||t.getFullYear()!=e.getFullYear()}()){_.s.st=1;{f("logic() - running...");let l={url:"https://dashboard.elering.ee/api/nps/price/"+_.c.g+"/current",timeout:5,ssl_ca:"*"};Shelly.call("HTTP.GET",l,function(e,t,s){l=null;try{if(0!==t||null==e||200!==e.code||!e.body)throw Error("error: "+t+"("+s+") - "+JSON.stringify(e));{e.headers=null,s=e.message=null;var n=JSON.parse(e.body);e=null,_.s.p=n.data[0].price/10*(100+(0<n.data[0].price?_.c.v:0))/100;let t=0;_.s.st=3;for(let e=0;e<_.c.c.length;e++){var r=_.c.c[e][0];null!=r&&_.s.p>=r&&(t<=1||r>=_.c.c[t][0])&&(t=e)}0<t&&(_.s.st=4),_.s.c=t,f("logic() - price: "+_.s.p.toFixed(2)+" c/kWh - "+JSON.stringify(_.c.c[t])+" (rule #"+t+")"),e=null,g(!1,function(e){e?_.s.chkTs=Math.floor(Date.now()/1e3):(_.s.errCnt++,_.s.errTs=c(),_.s.st=2,_.s.c=1,g()),o=!1})}}catch(t){_.s.errCnt++,_.s.errTs=c(),_.s.st=2,_.s.c=1,g(),f("logic() - error:"+t),o=!1}})}}else o=!1;else _.s.c=1,g(),e=!0,o=!1;else a(!(_.s.st=0))}catch(e){f("loop() - error:"+e),o=!1}}function g(e,t){try{var s=new Date,n=null==i?_.c.c[_.s.c]:i,r={rgb:[Math.min(Math.max(0,Math.floor(n[1]/255*100)),100),Math.min(Math.max(0,Math.floor(n[2]/255*100)),100),Math.min(Math.max(0,Math.floor(n[3]/255*100)),100)],brightness:Math.min(100,Math.max(0,n[4]))},l=(e&&(r.brightness=0),(s.getHours()>=_.c.ns||s.getHours()<_.c.ne)&&(r.brightness=Math.min(Math.max(0,r.brightness+_.c.nb),100)),{config:{leds:{mode:"switch",colors:{"switch:0":{on:Object.assign({},r),off:r}}}}});l.config.leds.colors["switch:0"].on.brightness=Math.min(100,Math.max(0,n[4]+_.c.ob)),_.s.f=n[5],Shelly.call("PLUGS_UI.SetConfig",l,function(e,t,s,n){0===t?n&&n(!0):(f("setPlugConfig(): Error setting RGB: "+t+":"+s),n&&n(!1))},t)}catch(e){f("setPlugConfig() - error:"+e),t&&t(!1)}}f("shelly-plug-nordpool-light v."+_.s.v),f("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId()),HTTPServer.registerEndpoint("",function(s,n){try{if(o)return s=null,n.code=503,void n.send();var r=function(e){var t={},s=e.split("&");for(let e=0;e<s.length;e++){var n=s[e].split("=");t[n[0]]=n[1]}return t}(s.query);s=null;let e="application/json",t=(n.code=200,!0);"s"===r.r?(u(),n.body=JSON.stringify(_),t=!1):"ts"===r.r?(i=JSON.parse(r.c),Timer.set(500,!1,g)):"te"===r.r?(i=null,Timer.set(500,!1,g)):"r"===r.r?(a(_.s.configOK=!1),_.s.chkTs=0,n.code=204,t=!1):r.r?"s.js"===r.r?(n.body=atob("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"),e="text/javascript"):"s.css"===r.r?(n.body=atob("H4sIAAAAAAAACoVWYY/iNhD9K1OtToIVDgks1yVIq/bTSVVV9Uv73YmdxLeOHdlmF+7Ef+/YScAEUFerkNgz4+fneS9ZPj/DM9iGS3kkndzXRGnDOq0lkaJuHPjpWTmHP/bWChBWOyo1EGic6/Ll8vswklQCA/2gxdFauGZfJKVuzwHL/1njT1FyZXkO3/76B36vKm40fOOKGyrh730hRTmGwMc6SeF5iUk/odAHYsUPoeoc7w3jhuDQDk74xI4LoBhTaqlNDk+8rNIqG+d8Mi3fa6P3iuHsqlzzTboDKRQnDffAcsiSF97uoNLK+WUQXppszyMVbYU85vAvN4wquoOWHsinYK7J4WVrfNzwlKXpFz9taqGwBtC90zvoKGMB+aY7YEgXcD854SRHdNGiWbLyxfp83KBzus1hNSSUujtex6fJq4+nSK8ilssqh0ryA+GK7cDxgyNhKgfjtzkUUY4rh3WuIDvd4ULJrxtfT/IKOUkj4FnY5BWPVVXtzpSPpJ4gwUpYnAnbSYqc1UYgFn8ljrc45jjBrH2rLJatTKDI34Rk2ylM7rRAkIbwD0SKYUorfqE4WQUwl6Prn/uu8Jz4Z7BaCgbOUGU7arDOGEFGzBktym15Hkbc49RnIxw/TxjKxB5RbDxPVImWOqGRU481s6GPqAGhKqFC2gl+e+fHytCWW+g35DnGn4Cm0gbP1KBYHJ+tv6aM13PMOYGjheRJWb4537Zvzrw5llfCWEfKRki2gKSoF0OYbd9cwynDsDhmbI/PgZxCS2T/gxsnSirHbsCtTg5z5AKxt5wJOos7/BU7du7hh5XbGF980oXU5ftECad7SRPAQ7cPTed7/XIioQvPeu/lkEZl4Wb7cW6Gcisk7rPvhkuebac6+oot84toO20cVUEpSdvEu+t78HxOl5WwvcqgkTTuMEk7b3Lj3S0tF6x3cMaG0Yuq9PxHgkaHRIWEuc/sNY3k/Dr4S9K6LL3Q2xMyzAnV7d3EeTIvoscEbSOX610tig27OYNe+0UegA0Ki3kVKhjxdfO8lM3uip1ezYGjUKYTSBY6/t5YL9jBMILBdWGm01b0Mq3EgbNz5dUm9or1tHQsisEFfhChGD/ksMW/wSiDFfQNG24jYYdb73IzglML8Nf5aJTDKtfHe9NiSUWZbzDtO8sdPfv4Nrtvihhd3Bd9TwWpjT+b0SzXoQFuaLul+ilN02s6ep/DemiHiGCGrh3eKgswdTFbbTYLGC/zaCzF//k0ZhxJHzxfaqShwm3NaUQ6n99oLOwfvxIu4giHdc3Fo61P3+H3ZJQUK4vFo3cCfr+od24Ax63jHbGOGvfo3TAG//S4rj5TJi8idJ3/AN75yP3ACQAA"),e="text/css"):n.code=404:(n.body=atob("H4sIAAAAAAAACo1VbW/bNhD+K5yAFAlqyfa3wpZYtGk2tAvSoA66jwNNnSXGFKmRJzvesP++oyg7ykuLfZAg3vHennvulP9SWomHFmpsNM/Dm2lhqgIMzxtAwWQtnAcsOtyk73iOCjXwVQ1aH9it7nx4Vfk0yqOJEQ0UOwX71jpk0hoEg0WyVyXWRQk7JSHtDxNlFCqhUy+FhmKe8LxUOya18L5AyVRZtHLLV6BBBkfauv5ClKeVK3k+JQEfS9f24RUpPuBYGkM0OJ8xjweKnZTKt1ocFpVT5TK8UoSGJAgpBe4a4xfzjWP0xCx5rkzbIQvgFesO0ZpjLGPZTugOikthJOhR3J8Y2e1g9PX3ISWhVWVSD3qzAHOqdPwegWXbU7lDK3wrzLHOetSxiuXToOMpu7GuZLfWanatqhqfouZbdbT3rXkGqbTtgb8J7yX70nmv2GdvUWjLznPBagebokZs/WI6vVdRk20UQ+Eq4tKfa+LYlo80+VTwixe19YF69hDxxFrDkE/SMCmpDejoKQfhfv5uxlcosPNBGCpIPfJrK0plqizLhuv8g0S1g4FOx5vy6I3fOuInM3Z/0tH3Sfupp29P8ZO+DOj0+Y1bkhCB1yxQLOGrq7u7zze/rYba/l8tl7Yz6A4hau7jCFC4iue2RUXEiXTZKP6rMoRn+VQOwK888UuJp3K949cCdy/EhJTCuhPBYBrDnYr+/uEuPevziPSlNHbMq79pbOYs4ezsePFrh0FvTTh8dIFUBrxnorzvPC7Yo71dRwfzkfVNuM9o2SA1zPfxniHle7DieDTEJWUWokPLn3pA1TdnlK3xx2iL2YylozwMjDRHNy8yf+btldw/amW2TGht91COrveTLmuQW9pLvfHmkSyD7bdOg39sPkp+qZXcRoYytCy2I1+7yK9Yf79BF/PZ7GzZiId0dLQ7cBtKJH04ojNCkSB8gd8yftPqpI3UkJOWVijWIMpTjuF5U8GSyen2jzqcLof5GaF1AiJ83IFH5sIYrW156Gd5Uz3W3k9CRK3pu1aCdCA8sPiHYFptIHSS2tWRVCA72M4xuzfMKb/9wcTFeXvslRc06uN1G+m+IvGzTePTV/yMN5KXTrXIaSNRYZ+uvlMHTGn3mbZShEnKLAGhTKaM1F0J/jwJGl1bj8nFUgOhAX998QUU/J+dcMwX9O/tGtpuWagc4UpDOJ0nMRIZ+cw7WVCs97BI3rsieQuZA/orSThPqP40mSTJxeTkJyCdibal/8VlrXR57i/+nUj/40gBf4pDV8ivLuJo+RoAk2CX9Zs8xE98RuekzyJ+/iQqqS8mfbFUS3bvE1rtA3r/ASOG8w9xCAAA"),e="text/html"),n.headers=[["Content-Type",e]],t&&n.headers.push(["Content-Encoding","gzip"])}catch(e){f("http - error:"+e),n.code=500}n.send()}),Timer.set(1e4,!0,h),Timer.set(2e3,!0,function(){var e;t=!t,o||(e=(e=(new Date).getHours())>=_.c.ns||e<_.c.ne,_.s.fa=e&&_.c.nf||!e||null!=i,_.s.f&&_.s.fa&&g(t))}),h();