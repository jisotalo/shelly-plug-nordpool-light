/**
 * @license
 * 
 * shelly-plug-nordpool-light
 * 
 * (c) Jussi isotalo - http://jisotalo.fi
 * https://github.com/jisotalo/shelly-plug-nordpool-light
 * 
 * License: GNU Affero General Public License v3.0 
 */
let l="shelly-plug-nordpool-light",C_ERRC=3,C_ERRD=120,C_DEF={g:"fi",v:24,ns:22,ne:6,nb:50,nf:0,ob:150,c:[[null,255,255,255,0,0],[null,255,0,0,50,1],[-999,0,255,0,10,0],[5,255,255,0,25,0],[10,255,120,0,15,0],[15,255,64,0,25,0],[20,255,0,0,10,0],[null,255,255,255,100,0]]},_={s:{v:"1.1.0",dn:"",st:0,chkTs:0,errCnt:0,errTs:0,configOK:0,p:null,c:1,f:0,fa:0},c:C_DEF},c=!1,n=!1,o=null,e=!1;function i(e){return Math.floor((e?e.getTime():Date.now())/1e3)}function f(e){console.log((new Date).toString().substring(16,24)+":",e)}function a(){var e=new Date;_.s.timeOK=2e3<e.getFullYear()?1:0,_.s.dn=Shelly.getComponentConfig("sys").device.name,!_.s.upTs&&_.s.timeOK&&(_.s.upTs=i(e))}function u(e){Shelly.call("KVS.Get",{key:l},function(n,e,s,t){_.c=n?n.value:{},"function"==typeof USER_CONFIG&&(_.c=USER_CONFIG(_.c,_,!0));{n=function(e){_.s.configOK=e?1:0,_.s.chkTs=0,t&&(c=!1,Timer.set(1e3,!1,h))};let e=0;if(C_DEF){for(var r in C_DEF)void 0===_.c[r]&&(_.c[r]=C_DEF[r],e++);C_DEF=null,0<e?Shelly.call("KVS.Set",{key:l,value:_.c},function(e,n,s,t){0!==n&&f("chkConfig() - error:"+n+" - "+s),t&&t(0===n)},n):n&&n(!0)}else n&&n(!0)}},e)}function h(){try{if(!c)if(c=!0,a(),_.s.configOK)if(e)if(function(){var e=new Date;{if(_.s.errCnt>=C_ERRC&&i(e)-_.s.errTs<C_ERRD)return C_ERRD,i(e),void _.s.errTs;_.s.errCnt>=C_ERRC&&(_.s.errCnt=0)}if(0==_.s.chkTs)return 1;var n=new Date(1e3*_.s.chkTs);return n.getHours()!=e.getHours()&&0<e.getMinutes||n.getFullYear()!=e.getFullYear()}()){_.s.st=1;{f("logic() - running...");let l={url:"https://dashboard.elering.ee/api/nps/price/"+_.c.g+"/current",timeout:5,ssl_ca:"*"};Shelly.call("HTTP.GET",l,function(e,n,s){l=null;try{if(0!==n||null==e||200!==e.code||!e.body)throw Error("error: "+n+"("+s+") - "+JSON.stringify(e));{e.headers=null,s=e.message=null;var t=JSON.parse(e.body);e=null,_.s.p=t.data[0].price/10*(100+(0<t.data[0].price?_.c.v:0))/100;let n=0;_.s.st=3;for(let e=0;e<_.c.c.length;e++){var r=_.c.c[e][0];null!=r&&_.s.p>=r&&(n<=1||r>=_.c.c[n][0])&&(n=e)}0<n&&(_.s.st=4),_.s.c=n,f("logic() - price: "+_.s.p.toFixed(2)+" c/kWh - "+JSON.stringify(_.c.c[n])+" (rule #"+n+")"),e=null,g(!1,function(e){e?_.s.chkTs=Math.floor(Date.now()/1e3):(_.s.errCnt++,_.s.errTs=i(),_.s.st=2,_.s.c=1,g()),c=!1})}}catch(n){_.s.errCnt++,_.s.errTs=i(),_.s.st=2,_.s.c=1,g(),f("logic() - error:"+n),c=!1}})}}else c=!1;else _.s.c=1,g(),e=!0,c=!1;else u(!(_.s.st=0))}catch(e){f("loop() - error:"+e),c=!1}}function g(e,n){try{var s=new Date,t=null==o?_.c.c[_.s.c]:o,r={rgb:[Math.min(Math.max(0,Math.floor(t[1]/255*100)),100),Math.min(Math.max(0,Math.floor(t[2]/255*100)),100),Math.min(Math.max(0,Math.floor(t[3]/255*100)),100)],brightness:Math.min(100,Math.max(0,t[4]))},l=(e&&(r.brightness=0),(s.getHours()>=_.c.ns||s.getHours()<_.c.ne)&&(r.brightness=Math.min(Math.max(0,r.brightness*(_.c.nb/100)),100)),{config:{leds:{mode:"switch",colors:{"switch:0":{on:Object.assign({},r),off:r}}}}});l.config.leds.colors["switch:0"].on.brightness=Math.min(100,Math.max(0,r.brightness*(_.c.ob/100))),_.s.f=t[5],Shelly.call("PLUGS_UI.SetConfig",l,function(e,n,s,t){0===n?t&&t(!0):(f("setPlugConfig(): Error setting RGB: "+n+":"+s),t&&t(!1))},n)}catch(e){f("setPlugConfig() - error:"+e),n&&n(!1)}}f("shelly-plug-nordpool-light v."+_.s.v),f("URL: http://"+(Shelly.getComponentStatus("wifi").sta_ip??"192.168.33.1")+"/script/"+Shelly.getCurrentScriptId()),HTTPServer.registerEndpoint("",function(s,t){try{if(c)return s=null,t.code=503,void t.send();var r=function(e){var n={},s=e.split("&");for(let e=0;e<s.length;e++){var t=s[e].split("=");n[t[0]]=t[1]}return n}(s.query);s=null;let e="application/json",n=(t.code=200,!0);"s"===r.r?(a(),t.body=JSON.stringify(_),n=!1):"ts"===r.r?(o=JSON.parse(r.c),Timer.set(500,!1,g)):"te"===r.r?(o=null,Timer.set(500,!1,g)):"r"===r.r?(u(_.s.configOK=!1),_.s.chkTs=0,t.code=204,n=!1):r.r?"s.js"===r.r?(t.body=atob("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"),e="text/javascript"):"s.css"===r.r?(t.body=atob("H4sIAAAAAAAACoVWYY/iNhD9K1OtToIVDgks1yVIq/bTSVVV9Uv73YmdxLeOHdlmF+7Ef+/YScAEUFerkNgz4+fneS9ZPj/DM9iGS3kkndzXRGnDOq0lkaJuHPjpWTmHP/bWChBWOyo1EGic6/Ll8vswklQCA/2gxdFauGZfJKVuzwHL/1njT1FyZXkO3/76B36vKm40fOOKGyrh730hRTmGwMc6SeF5iUk/odAHYsUPoeoc7w3jhuDQDk74xI4LoBhTaqlNDk+8rNIqG+d8Mi3fa6P3iuHsqlzzTboDKRQnDffAcsiSF97uoNLK+WUQXppszyMVbYU85vAvN4wquoOWHsinYK7J4WVrfNzwlKXpFz9taqGwBtC90zvoKGMB+aY7YEgXcD854SRHdNGiWbLyxfp83KBzus1hNSSUujtex6fJq4+nSK8ilssqh0ryA+GK7cDxgyNhKgfjtzkUUY4rh3WuIDvd4ULJrxtfT/IKOUkj4FnY5BWPVVXtzpSPpJ4gwUpYnAnbSYqc1UYgFn8ljrc45jjBrH2rLJatTKDI34Rk2ylM7rRAkIbwD0SKYUorfqE4WQUwl6Prn/uu8Jz4Z7BaCgbOUGU7arDOGEFGzBktym15Hkbc49RnIxw/TxjKxB5RbDxPVImWOqGRU481s6GPqAGhKqFC2gl+e+fHytCWW+g35DnGn4Cm0gbP1KBYHJ+tv6aM13PMOYGjheRJWb4537Zvzrw5llfCWEfKRki2gKSoF0OYbd9cwynDsDhmbI/PgZxCS2T/gxsnSirHbsCtTg5z5AKxt5wJOos7/BU7du7hh5XbGF980oXU5ftECad7SRPAQ7cPTed7/XIioQvPeu/lkEZl4Wb7cW6Gcisk7rPvhkuebac6+oot84toO20cVUEpSdvEu+t78HxOl5WwvcqgkTTuMEk7b3Lj3S0tF6x3cMaG0Yuq9PxHgkaHRIWEuc/sNY3k/Dr4S9K6LL3Q2xMyzAnV7d3EeTIvoscEbSOX610tig27OYNe+0UegA0Ki3kVKhjxdfO8lM3uip1ezYGjUKYTSBY6/t5YL9jBMILBdWGm01b0Mq3EgbNz5dUm9or1tHQsisEFfhChGD/ksMW/wSiDFfQNG24jYYdb73IzglML8Nf5aJTDKtfHe9NiSUWZbzDtO8sdPfv4Nrtvihhd3Bd9TwWpjT+b0SzXoQFuaLul+ilN02s6ep/DemiHiGCGrh3eKgswdTFbbTYLGC/zaCzF//k0ZhxJHzxfaqShwm3NaUQ6n99oLOwfvxIu4giHdc3Fo61P3+H3ZJQUK4vFo3cCfr+od24Ax63jHbGOGvfo3TAG//S4rj5TJi8idJ3/AN75yP3ACQAA"),e="text/css"):t.code=404:(t.body=atob("H4sIAAAAAAAACo1VbW/bNhD+K5yAFAkayfa3wpZYtGk2tAvSoA66jwNNnSXGFKmRJzvesP++oyjbykuLfZAg3vHennvulP9SWon7FmpsNM/Dm2lhqgIMzxtAwWQtnAcsOlyn73iOCjXwZQ1a79md7nx4VfkkyqOJEQ0UWwW71jpk0hoEg0WyUyXWRQlbJSHtD5fKKFRCp14KDcUs4Xmptkxq4X2BkqmyaOWGL0GDDI60df2FKE8rV/J8QgI+lq7s4ytSfMSxNIZocDZlHvcUOymVb7XYzyunykV4pQgNSRBSCtw1xs9na8foiVnyXJm2QxbAK1YdojWHWMayrdAdFFfCSNCjuD8xspvB6OvvQ0pCq8qkHvR6DuZY6fg9Asu2x3KHVvhWmEOd9ahjFUtZPglafmtdye6s1exGVTU+Rc236mDvW/MMUmnbPX8T3gv2pfNesc/eotCWneeC1Q7WRY3Y+vlk8qCiJlsrhsJVxKU/V8SxDR9p8ongFy9q6wP17CHiiZWGIZ+kYVJSG9DRUw7C3ezdlC9RYOeDMFSQeuQ3VpTKVFmWDdf5B4lqCwOdDjflwRu/c8RPZuzuqKPvo/ZTT9+e4kd9GdDp8xu3JCECr1igWMKX1/f3n29/Ww61/b9armxn0O1D1NzHEaBwFc9ti4qIE+myVvxXZQjP8qkcgF974pcST+V6y28Ebl+ICSmFdSeCwSSGOxb9/cN9etbnEelLaWyZV3/T2MxYwtnZ4eLXDoPemnD46AKpDHjPRPnQeZyzk71dRQezkfVtuM9o2SA1zPfxniHle7DieDTEJWXmokPLn3pA1TdnlK3xh2jz6TTw/6SBkebg5kXmz7y9kvtHrcyGCa3tDsrR9X7SZQ1yQ3upN16fyDLYfus0+FPzUfIrreQmMpShZbEd+cpFfsX6+w06n02nZ4tGPKajo92CW1Mi6eMBnRGKBOEL/Bbxm1YnbaSGnLS0QrEGUR5zDM+bChZMTjZ/1OF0NczPCK0jEOHjHjwyF8ZoZct9P8vr6lR7PwkRtabvWgnSgfDA4h+CabWG0ElqV0dSgWxvO8fszjCn/OYHExfn7dQrL2jUx+s20n1J4mebxqev+BlvJC+dapHTRqLCPl1/pw6Y0u4ybaUIk5RZAkKZTBmpuxL8eRI0urYek4uFBkID/vriCyj4P1vhmC/o39s1tN2yUDnCtYZwOk9iJDLymXeyoFjvYZ68d0XyFjIH9FeScJ5Q/WlymSQXl0c/AelMtC39L65qpctzf/HvpfQ/jhTwpzh0hfzqIo6WrwEwCXZZv8lD/MRndE76LOLnT6KS+uKyL5ZqyR58Qqt9QO8/aX9VIHEIAAA="),e="text/html"),t.headers=[["Content-Type",e]],n&&t.headers.push(["Content-Encoding","gzip"])}catch(e){f("http - error:"+e),t.code=500}t.send()}),Timer.set(1e4,!0,h),Timer.set(2e3,!0,function(){var e;n=!n,c||(e=(e=(new Date).getHours())>=_.c.ns||e<_.c.ne,_.s.fa=e&&_.c.nf||!e||null!=o,_.s.f&&_.s.fa&&g(n))}),h();